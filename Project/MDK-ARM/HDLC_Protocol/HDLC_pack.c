#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include "HDLC_pack.h"
#include "MAC_Pack.h"
#include "CRC.h"
//--------------------------------------------------------------------------------
#define FLAG                   0x7e
#define CONTROL_FIELDS_SIZE      14
#define LEN_DATA_REQUEST         16
//--------------------------------------------------------------------------------
#pragma pack(push,1)
#pragma anon_unions
typedef enum {
  SEND_CURRENT_A=0,
  SEND_CURRENT_B,
  SEND_CURRENT_C,
  SEND_VOLT_A,
  SEND_VOLT_B,
  SEND_VOLT_C,
  SEND_SUM_Q,
  SEND_SUM_P,
  SEND_SUM_S,
  SEND_COS_F,
  SEND_ACTIV_ENERGE_IMPORT,
  SEND_REACTIV_ENERGE_IMPORT
}t_send_stat_param;
typedef union {
  uint8_t point;
  struct
  {
    unsigned I: 1;
    unsigned NR:3;
    unsigned PS:1;
    unsigned NS:3;
  };
} t_control_comand;
//--------------------------------------------------------------------------------
uint8_t Send_current_A[] =             {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x1F,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_current_B[] =             {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x33,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_current_C[] =             {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x47,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_volt_A[] =                {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x20,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_volt_B[] =                {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x34,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_volt_C[] =                {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x48,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_sum_Q[] =                 {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x01,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_sum_P[] =                 {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x03,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_sum_S[] =                 {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x09,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_cos_f[] =                 {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x0D,0x07,0x00,0xFF,0x02, 0x00};
uint8_t Send_activ_energe_import[] =   {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x01,0x08,0x00,0xFF,0x02, 0x00};
uint8_t Send_reactiv_energe_import[] = {0xE6,0xE6,0x00,0xC0,0x01, 0x40,0x00,0x03,0x01,0x00, 0x03,0x08,0x00,0xFF,0x02, 0x00};

uint8_t* Send_comands_points[] = {Send_current_A, Send_current_B, Send_current_C, Send_volt_A, Send_volt_B, Send_volt_C, Send_sum_Q,
                                  Send_sum_P, Send_sum_S, Send_cos_f, Send_activ_energe_import, Send_reactiv_energe_import};
uint8_t posParam=0;
uint8_t DA_SA[] = { 0x00, 0x02, 0x44, 0xC9, 0x41 };
  uint8_t request_connect[] = {0x7E, 0xA0, 0x23, 0x00, 0x02, 0x44, 0xC9, 0x41, 0x93, 0x77, 0x28, 0x81, 0x80, 0x14, 0x05, 0x02,
  0x04, 0x00, 0x06, 0x02, 0x04, 0x00, 0x07, 0x04, 0x00, 0x00, 0x00, 0x01, 0x08, 0x04, 0x00, 0x00,
  0x00, 0x01, 0x72, 0xE3, 0x7E };
  
  uint8_t request_authorize[] = { 0x7E, 0xA0, 0x47, 0x00, 0x02, 0x44, 0xC9, 0x41, 0x10, 0x17, 0x55, 0xE6, 0xE6, 0x00, 0x60, 0x36,
  0xA1, 0x09, 0x06, 0x07, 0x60, 0x85, 0x74, 0x05, 0x08, 0x01, 0x01, 0x8A, 0x02, 0x07, 0x80, 0x8B,
  0x07, 0x60, 0x85, 0x74, 0x05, 0x08, 0x02, 0x01, 0xAC, 0x0A, 0x80, 0x08, 0x31, 0x32, 0x33, 0x34,
  0x35, 0x36, 0x37, 0x38, 0xBE, 0x10, 0x04, 0x0E, 0x01, 0x00, 0x00, 0x00, 0x06, 0x5F, 0x1F, 0x04,
  0x00, 0xFF, 0xFF, 0xFF, 0x08, 0x00, 0xD5, 0x24, 0x7E };
  
  uint8_t request_volt_C[] = { 0x7E, 0xA0, 0x1C, 0x00, 0x02, 0x44, 0xC9, 0x41, 0x32, 0x4A,
                               0x53, 0xE6, 0xE6, 0x00, 0xC0, 0x01, 0x40, 0x00, 0x03, 0x01,
                               0x00, 0x48, 0x07, 0x00, 0xFF, 0x02, 0x00, 0xE6, 0xE2, 0x7E };

  uint8_t request_Current_C[] = { 0x7E, 0xA0, 0x1C, 0x00, 0x02, 0x44, 0xC9, 0x41, 0x32,
                                  0x4A, 0x53, 0xE6, 0xE6, 0x00, 0xC0, 0x01, 0x40, 0x00,
                                  0x03, 0x01, 0x00, 0x48, 0x07, 0x00, 0xFF, 0x02, 0x00,
                                  0xE6, 0xE2, 0x7E };
uint8_t buf[100] = {0};
//--------------------------------------------------------------------------------

uint8_t HDLC_PackSendConfigParam(void (*uartSendDataCB)(uint8_t *data, uint16_t len))
{
  uartSendDataCB(request_connect, sizeof(request_connect));
  return 0;
}

uint8_t HDLC_PackSendAuthorization(void (*uartSendDataCB)(uint8_t *data, uint16_t len))
{  
  uartSendDataCB(request_authorize, sizeof(request_authorize));
  return 0;
}

uint8_t HDLC_PackSendComandVolt(void (*uartSendDataCB)(uint8_t *data, uint16_t len))
{
  uartSendDataCB(request_volt_C, sizeof(request_volt_C));
  return 0;
};

uint8_t HDLC_PackSendComandCurrent(void (*uartSendDataCB)(uint8_t *data, uint16_t len))
{  
  uartSendDataCB(request_Current_C, sizeof(request_volt_C));
  return 0;
};
//--------------------------------------------------------------------------------

uint8_t HDLC_PackSendComand(uint8_t N,void (*uartSendDataCB)(uint8_t *data, uint16_t len))
{
  uint16_t len = 50;
  uint16_t pack_size = LEN_DATA_REQUEST + CONTROL_FIELDS_SIZE;
  t_control_comand control;
  control.NR = N;
  control.PS = 1;
  control.NS = N;
  control.I =  0;

  if( posParam >= 12/*sizeof(Send_comands_points)*/ ) posParam = 0;
/*
  if (*pack_size > len)
    return 1;//предоставленно недостаточно места
*/
  t_HDLC_packet p_pack;
  p_pack.begin = (t_HDLC_packet_begin*)buf;
  p_pack.end = (t_HDLC_packet_end*) (&buf[ pack_size - sizeof(t_HDLC_packet_end) ]);

  p_pack.begin->flag_open = FLAG;

  p_pack.begin->format.form.typ = FORMAT_TYPE;
  p_pack.begin->format.form.S = FORMAT_S;
  p_pack.begin->format.form.size = LEN_DATA_REQUEST + CONTROL_FIELDS_SIZE-2;
  p_pack.begin->format.point = swap((uint8_t*)&p_pack.begin->format.point, 2);

  memcpy(p_pack.begin->DA_SA, DA_SA, sizeof(DA_SA));
  p_pack.begin->control = control.point;
  p_pack.begin->HCS = f_crc16( ( (uint8_t*) &p_pack.begin->format.point ), HEADER_LEN );
  memcpy((uint8_t*)&p_pack.begin->data, Send_comands_points[posParam], LEN_DATA_REQUEST);
  p_pack.end->FCS = f_crc16(((uint8_t*)&p_pack.begin->format.point), pack_size - 4);
  p_pack.end->flag_close = FLAG;

  uartSendDataCB(buf, pack_size);

  return posParam++;
};
#pragma pack(pop)